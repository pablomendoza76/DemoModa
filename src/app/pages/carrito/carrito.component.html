<div class="carrito-grid" *ngIf="carrito.length > 0; else vacio">
  <!-- ğŸ§¾ Lista de productos -->
  <div class="carrito-items">
    <h2 class="carrito-titulo">ğŸ›ï¸ Mi carrito ({{ carrito.length }})</h2>

    <div class="item-carrito" *ngFor="let item of carrito">
      <div class="item-imagen">
        <img [src]="item.imagen_url" [alt]="item.nombre" />
      </div>

      <div class="item-info">
        <div class="nombre-precio">
          <h3 class="nombre">{{ item.nombre }}</h3>
          <p class="precio">{{ item.precio | currency }}</p>
        </div>

        <div class="variantes">
          <span class="talla">Talla: {{ item.talla }}</span>
        </div>

        <div class="cantidad">
          <label for="cantidad-{{ item.id }}">Cantidad </label>
          <div class="cantidad-controles" id="cantidad-{{ item.id }}">
            <button (click)="restarCantidad(item)">âˆ’</button>
            <span class="cantidad-numero">{{ item.cantidad }}</span>
            <button (click)="sumarCantidad(item)">+</button>
          </div>
        </div>
      </div>

      <div class="item-eliminar">
        <button (click)="removerItem(item)">Ã—</button>
      </div>
    </div>
  </div>

  <!-- ğŸ“¦ Resumen -->
  <div class="resumen-pedido">
    <h3>Resumen</h3>

    <div class="linea">
      <span>Subtotal:</span>
      <span>{{ total | currency }}</span>
    </div>

    <div class="linea" *ngIf="descuento > 0">
      <span>Descuento:</span>
      <span>-{{ total * descuento | currency }}</span>
    </div>

    <div class="linea">
      <span>EnvÃ­o:</span>
      <span>Gratis</span>
    </div>

    <div class="linea total">
      <span>Total:</span>
      <strong>{{ totalConDescuento | currency }}</strong>
    </div>

    <div class="cupon">
      <label for="cuponInput">Â¿Tienes un cupÃ³n?</label>
      <input
        id="cuponInput"
        type="text"
        placeholder="Ingresa tu cÃ³digo"
        [(ngModel)]="cuponIngresado"
      />
      <button class="btn aplicar" (click)="aplicarCupon()">Aplicar</button>
    </div>

    <button class="btn comprar" (click)="abrirModalPedido()">
      ğŸ›’ Realizar pedido
    </button>
    <button class="btn vaciar" (click)="vaciarCarrito()">
      ğŸ—‘ Vaciar carrito
    </button>
    <button class="btn historial" (click)="abrirModalHistorialVentas()">
      ğŸ“‹ Ver mis compras anteriores
    </button>

    <button class="btn volver" (click)="volver()">â† Volver a productos</button>
  </div>
</div>

<!-- ğŸ›’ Carrito vacÃ­o -->
<ng-template #vacio>
  <div class="carrito-vacio">
    <p>ğŸ›’ Tu carrito estÃ¡ vacÃ­o</p>
    <button class="btn volver" (click)="volver()">â† Volver a productos</button>
  </div>
</ng-template>

<!-- ğŸ“‹ MODAL DE FACTURACIÃ“N -->
<div class="modal-overlay" *ngIf="mostrarModalFacturacion">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Formulario de FacturaciÃ³n</h2>
      <button class="cerrar" (click)="cerrarModalFacturacion()">Ã—</button>
    </div>

    <form
      (ngSubmit)="enviarFormulario()"
      #formFactura="ngForm"
      class="formulario-facturacion"
    >
      <label>Nombre completo:</label>
      <input
        type="text"
        name="nombre"
        [(ngModel)]="datosFactura.nombre"
        required
      />

      <label>Correo electrÃ³nico:</label>
      <input
        type="email"
        name="correo"
        [(ngModel)]="datosFactura.correo"
        required
      />

      <label>DirecciÃ³n:</label>
      <textarea
        name="direccion"
        [(ngModel)]="datosFactura.direccion"
        required
      ></textarea>

      <label>TelÃ©fono:</label>
      <input
        type="tel"
        name="telefono"
        [(ngModel)]="datosFactura.telefono"
        required
      />

      <label>MÃ©todo de pago:</label>
      <select name="metodoPago" [(ngModel)]="datosFactura.metodoPago" required>
        <option value="" disabled selected>Seleccione una opciÃ³n</option>
        <option value="tarjeta">Tarjeta</option>
        <option value="paypal">PayPal</option>
      </select>

      <!-- TARJETA -->
      <div *ngIf="datosFactura.metodoPago === 'tarjeta'">
        <label>NÃºmero de tarjeta:</label>
        <input
          type="text"
          name="tarjetaNumero"
          [(ngModel)]="datosFactura.tarjetaNumero"
          required
        />

        <label>Nombre en la tarjeta:</label>
        <input
          type="text"
          name="tarjetaNombre"
          [(ngModel)]="datosFactura.tarjetaNombre"
          required
        />

        <label>ExpiraciÃ³n:</label>
        <input
          type="text"
          name="tarjetaExpiracion"
          placeholder="MM/AA"
          [(ngModel)]="datosFactura.tarjetaExpiracion"
          required
        />

        <label>CVV:</label>
        <input
          type="text"
          name="tarjetaCVV"
          [(ngModel)]="datosFactura.tarjetaCVV"
          required
        />
      </div>

      <!-- PAYPAL -->
      <div *ngIf="datosFactura.metodoPago === 'paypal'">
        <label>Correo de PayPal:</label>
        <input
          type="email"
          name="paypalCorreo"
          [(ngModel)]="datosFactura.paypalCorreo"
          required
        />
      </div>

      <p class="total-pagar">
        Total a pagar: <strong>{{ totalConDescuento | currency }}</strong>
      </p>

      <div class="resumen-carrito-modal">
        <h2>Productos seleccionados</h2>
        <ul>
          <li *ngFor="let item of carrito">
            {{ item.nombre }} Ã— {{ item.cantidad }} -
            {{ item.precio * item.cantidad | currency }}
          </li>
        </ul>
      </div>

      <button type="submit" class="btn confirmar">Confirmar pedido</button>
    </form>
  </div>
</div>

<!-- ğŸ“œ Modal de historial de compras -->
<div class="modal-overlay" *ngIf="mostrarModalHistorial">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Historial de Compras</h2>
      <button class="cerrar" (click)="cerrarModalHistorial()">Ã—</button>
    </div>

    <div *ngIf="ventasCliente.length > 0; else sinVentas">
      <div *ngFor="let venta of ventasCliente" class="venta-card">
        <p><strong>ğŸ•“ Fecha:</strong> {{ venta.fecha | date : "short" }}</p>
        <p><strong>ğŸ“ DirecciÃ³n:</strong> {{ venta.direccion }}</p>
        <p><strong>ğŸ’³ MÃ©todo de pago:</strong> {{ venta.metodo_pago }}</p>
        <p *ngIf="venta.detalles_pago?.correo">
          <strong>âœ‰ï¸ Correo de pago:</strong> {{ venta.detalles_pago.correo }}
        </p>

        <div *ngIf="venta.productos?.length">
          <h4>ğŸ›’ Productos:</h4>
          <ul>
            <li *ngFor="let prod of venta.productos">
              {{ prod.nombre }} Ã— {{ prod.cantidad }} -
              {{ prod.precio_unitario | currency }}
            </li>
          </ul>
          <p style="margin-top: 0.5rem">
            <strong>Total pagado:</strong>
            {{ calcularTotalVenta(venta) | currency }}
          </p>
        </div>

        <hr />
      </div>
    </div>

    <ng-template #sinVentas>
      <p>No se encontraron ventas para este correo.</p>
    </ng-template>

    <ng-template #sinVentas>
      <p>No tienes compras registradas aÃºn.</p>
    </ng-template>
  </div>
</div>
